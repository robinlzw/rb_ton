大家好，我是Nikita。我们ICO评审大师最近获得了TON测试区块链的代码。在本文中，我不会详细介绍一般情况，而是会利用我那有限的开发技能来分析TON的情况。你会在这里找到基本的TON概念解释以及一些代码的深入审查。让我们看看投资者为17亿美元付出的代价是什么。

## **Readme**

我们这里有什么？README.txt包含了“轻客户端”的描述。“轻客户端”意味着我们不会下载整个区块链，而只是连接到某个云节点，并通过某种RPC连接与之通信，类似于以太坊区块链——如果你要下载以太坊的完整客户端，你需要在你的硬盘上留出约243 GB的空间。但有了轻客户端，你可以浏览账户、发送以太币和创建智能合约。

然后，他们说这只是测试代码，所以可能不完整、过时，甚至由于区块链开发版本的不可避免的重大变化而根本无法工作。这是开发者为开发者写的常规说明。它还包含了如何启动客户端和使用智能合约的手册。

## **配置**

让我们看看我们可以更改什么。根据ton-lite-client-test1.config.json代码，我们可以看到连接到节点的密钥、节点IP地址、访问端口、密钥类型以及节点类型。至少他们这里用了JSON文件，没有让我们使用环境变量。但YAML会更好，是的。看起来我们将拥有最轻量的客户端版本，它将连接到节点IP 1137658550。我希望我们有实际的节点代码——那将是个爆炸性的发现！它将包含完整的虚拟机、智能合约执行、甚至可能还有小马和幸福（根据TON白皮书）。

## **怎么做？**

HOWTO.txt文件给了我们关于如何使用TON区块链的直接说明，如何形成地址，如何编译智能合约，如何转移GRAMs以及如何在测试网络中使用faucet测试GRAMs。

## **真正的TON**

一个叫做ton.pdf的非常长的文档，包含140页，终于在这里解释了我们想知道的关于TON的一切。我会尝试简要解释一下主要要点。

TON术语包括主链、工作链和分片链。主链包含整体区块链状态及工作链哈希。工作链包含区块链中通常包含的内容（地址、交易、智能合约）并细分为分片链。分片链不包含通常的块，而是包含账户链——每个账户链本身就是一个小区块链。就像在面向对象编程（OOP）中所有东西都是对象，或者在函数式编程（FP）中所有东西都是函数，在TON中——所有东西都是区块链，即使它只是包含地址账户详情（因此得名——账户链）。我是区块链，你是区块链，你的猫是区块链，你的狗也是。所有东西都是区块链。

实际上，账户链并不存在——它们是虚拟的。就像在一袋弹珠中。你可以将所有弹珠分成10个一组，并称它们为“较小的弹珠袋”以便于计算更容易和更快——为了你的方便。但实际上，这仍然只是一个大袋的弹珠。因此，“虚拟”在这里的意思是“为了你的方便，但对机器来说是无关紧要的”。

此外，分片链和工作链都可以以光速互相发送消息。想要从一个分片链发送消息到另一个？嘭！它就在那里，在目标分片链的下一个块中。每个工作链最多可以有2³²个分片链，每个分片链最多可以有2⁶⁰个账户链。

工作链可以有不同的虚拟机、账户结构等。分片链在同一个工作链内始终具有相同的逻辑。

任何人都可以创建工作链，只要他们支付足够高的费用并获得2/3的验证者接受这个工作链，通过在逻辑上支持它的特点。

分片链实际上很酷。如果工作链的负载很大，它将分裂成更小的分片链以支持更快的交易和更高的负载——同时，如果负载下降，分片链将自动合并。所有这些都是自动完成的，以确保TON中的交易速度。

Telegram已经保留了工作链#0或基本工作链，其中GRAMs将会流通。

TON是一个用于创建区块链的平台。这个平台上创建的第一个区块链是GRAM流通网络，使用的第一个虚拟机是用来执行智能合约的。

TON将有验证者——大约100个。验证者持有的GRAMs越多，他们获得的GRAMs就越多，以保持区块链状态、执行智能合约并将新块附加到区块链上。每个工作链将有1024个小验证者，这些验证者是每1024个区块中伪随机选择的。它们是向主要验证者建议块的人员。如果验证者试图作弊，他们将被罚款失去GRAMs或暂时失去成为验证者的资格。

如果主链被分叉，大多数工作链也必须分叉。

任何人都可以通过向区块链报告不良验证者成为举报者，并通过举报获得GRAMs作为补偿。如果在区块链上发现了不良区块，区块链不会像我们习惯的主流区块链那样进行回滚和重新计算，而是通过类似波纹的过程从坏点向外自我修复。

文档的下一部分只是描述了各种类型的区块链。没有什么特别有趣的。

值得注意的是，对验证者的补偿将以GRAMs支付，GRAMs是基础工作链的基础货币。

工作链将能够拥有免费的和付费的状态存储。付费的（如以太坊有的）将使用户为每个操作付费——例如转账硬币。一些工作链的免费部分将受到工作链逻辑设置的阈值限制。也就是说，你可能能够在一些工作链上进行小额交易而无需支付费用。如果账户没有足够的钱来支付操作，账户将被销毁。Durovs认为验证者将免费提供删除这些无用账户的服务以减少区块链的大小，然而，一些工作链可能会引入奖励机制来执行此操作。

事实上，每个账户在TON中都是一个“演员”。“演员”可以接收消息并对其进行操作。例如，“演员”可以是一个智能合约，当它接收到资金时执行某些操作。消息可以凭空发送——你不必为此类消息消耗gas。

TON不能通过简单的暴力破解哈希来进行挖矿。相反，你必须成为验证者来执行智能合约、存储区块链状态并将区块添加到区块链上。TON有提名者的概念，而不是矿池。提名者将他们的GRAMs借给验证者。验证者持有的GRAMs越多，他们获得的GRAMs就越多——并且可以与他们的提名者分享奖励。如果验证者失去他们的GRAMs，提名者也会失去GRAMs。如果验证者的硬件性能差，他们可能会获得更少的奖励。

然后Nikolay告诉我们更多关于各种类型区块链的内容，13页之久。这有点像奇怪的炫耀和共产主义宣传，但还可以。

然后Durovs回答了Quora上最常见的问题：你能把Facebook上传到区块链上吗？答案是：不，愚蠢的，这样做的成本至少是Zuck现在支付的服务器费用的100倍。看来他们已经厌倦了他们的投资者问这样的问题。

当然，Nikolay不找简单的方法，是吗？SSL？不——MTProto。UDP？不——最好是设计我们自己的网络协议，带有一些附加功能。

除了新的和闪亮的网络和加密协议，Kolya还必须构建自己的DNS。你不能简单地使用某种奇怪的IP，不，我们需要自己的分布式TON成员地址列表。无可抱怨，但感觉有点过头了。

事实上，如果你曾经通过种子下载过任何东西，你应该已经熟悉这个概念。找到节点和其余的东西。接下来的10页是解释这一切如何工作的。

但这很酷，RON将能够作为DNS服务器工作。理论上，任何人都可以在他们的硬件上运行一个网站或服务，并告诉TON——然后任何人都可以直接连接。像洋葱网络，是的。

更好的是：Telegram也能够使用TON DNS，这将允许所有的Telegram客户端快速找到并连接到Telegram服务，使得当局的任何封锁尝试无效。

接下来的主题是TON支付。它以解释他们可能实现的各种方法开始，并继续他们选择的方法。

然后文档告诉我们关于GRAMs的信息。起初将有50亿GRAMs。你可以在自由市场上购买它们，也可以直接从TON购买。每个GRAM的价格将比前一个贵十亿分之一美元，起价为每GRAM 0.1美元。

Durovs解释说，这将有助于市场价格波动。

是的，它将有助于控制增长，但他们忘了提及这无法防止价格崩溃。当然，他们可以提供回购硬币——但这只会持续到他们的钱用完为止。

这标志着白皮书的结束。这是一个精彩的100多页的旅程。

---
## Fift or the new Forth

让我们从fiftbase.pdf和Fift编程语言的所有功能开始。我们刚刚适应了Vitalik的Solidity，现在我们又要学习一门新的编程语言。谢谢你，Kolya。

但让我们停止抱怨，深入了解它。值得一提的是，Fift是专门为TON的基础工作链和TON虚拟机创建的——其他工作链可以有不同的虚拟机和智能合约语言。

Fift使用波兰表示法作为其语法。支持者的观点是，这样新手就不会写出糟糕的代码了。反对者的观点是，有经验的开发人员现在将以严肃的表情写出这种糟糕的代码。语言越复杂，写出糟糕代码的可能性就越大。

好消息是——我们可以独立运行Fift文件，也可以在终端中使用沙盒。总的来说，带有波兰表示法的Fift阅读起来非常不容易。一旦失去专注力，你就得重新开始。你总是要在脑海中保持栈的状态。不过，好的一点是，你可以从左到右阅读所有代码。

有人可能会问：为什么要在编程语言中使用这种表示法？没有答案。它和通常的表示法有完全相同的东西：循环、哈希表、数组、变量、函数。你只是在上面添加了一种表示法，这会让大多数开发人员发疯。

总的来说，这只是一种新的编程语言。没有新的突破。我能预测的唯一事情是，由于Fift的复杂性和开发人员的错误，数百万美元可能会被盗。

此外，直接执行汇编命令很酷，但可能几乎没有人会使用它，因为主要的用例是为另一个ICO垃圾币创建一个去中心化的账本。

## **区块链规格**

让我们研究一下名为tblkch.pdf的文件。天哪。121页！此时我几乎肯定TON团队写的代码比他们的文档还少！

总的来说，普通读者从这份文件中学不到什么新东西。它专门为那些想要创建自己工作链的聪明人准备。这份文件是ton.pdf中的区块链文档的更长（或更短）版本。相同的区块链功能、区块、账户、类型、能力等的描述。

我很喜欢他们在第29页上给出的如何实现自己的加密货币的例子。看起来我们很快就会被新的加密货币淹没。

整个文档只是开发人员的参考。分片——概念解释。拆分和合并——概念解释。权益证明——概念解释。超立方体路由——概念解释。就像百科全书，但面向TON开发者。

总的来说，一切都写得很好，易于理解且相当合逻辑。我找不到任何明显的漏洞。

## **虚拟机**

那么我们在tvm.pdf文件中有什么？这是TON虚拟机实现的解释。基本上，它是如何在验证者的硬件上运行智能合约的。是的，155页的规格说明。为什么我甚至开始读这一切？

这份文档解释了使用CPU或GPU运行Fift代码的程序的底层。它真的像汇编语言规范，任何在大学从头构建编程语言的人都熟悉的东西。

寄存器文档、栈、数据类型、数据结构、函数解释、操作、永久存储等。就像重新阅读LLVM规范一样。你可以用Fift做的一切都在这份文档中列出。

没有突破，再次强调。它只是一个虚拟机，不多也不少。就像以太坊、EOS甚至比特币那样。


## **代码**

现在是浏览代码库的时候了。作为官方认证的TON区块链和技术专家（在阅读了500多页的手册后），我当然能够为你提供对轻客户端代码文件的第一印象。

像往常一样，我会从一般的事情开始。代码主要是用C++编写的，几乎没有正式的文档——只有在readme中概述了一般命令，这并不算太糟糕，因为我们有测试。我们都知道类型和测试是最好的文档。使用的许可证是LGPLv2——如果出现任何问题，TON概不负责。这类项目通常都是这样。

让我们浏览一下代码文件夹。

- **validator**——我认为这是显示在区块链浏览器中的验证器数据模型
- **ton**——实际的TON节点接口，它在云中运行；允许查看分片链、区块和地址的情况
- **tl**——这有点有趣：不同的工具，比如JSON编码和解码，以及基础的TLObject类
- **third-party**——只是第三方依赖项：abseil-cpp（标准C++库扩展）、crc32c（由Google提供的库）、rocksdb（由Facebook提供的键值存储）
- **test**——这个文件夹包含测试，显示TON轻客户端可以做什么——特别是观察区块链中的情况
- **terminal**——只是一个终端界面，用于运行命令
- **tdutils**——很高兴看到即使是TON开发人员也有一个文件夹，里面包含所有不能放到其他地方的实用功能：用于缓冲区、gzip、JSON、端口、堆、各种枚举等的助手
- **tdtl**——我认为这是Fift的数据结构（就像tl一样）
- **tdnet**——看起来是TON节点网络层的文件，我们可以通过UDP、TCP和FD连接到它
- **tddb**——我认为这是基于rocksdb的本地数据库持久存储
- **tdactor**——看起来很有希望（双关语），因为“actor”是TON的核心概念之一；我们可以在这里注意到promise和multipromise的实现
- **crypto**——各种加密功能以及完整的Fift编译器和虚拟机！看起来它用于编译智能合约。不错。
- **adnl**——之前讨论的网络层的隧道，看起来它运行在TCP或UDP上——几乎像SSL

正如我预料的那样，这只是轻客户端。没有挖矿，没有验证，没有特别和独特的功能（也不应该有）。事实上，它只是挂在指定IP地址上的TON云节点的一个包装器。你可以创建地址、获取测试GRAMs、发送消息和交易、创建智能合约。

对于代码本身，我没什么好说的。标准的C++代码——不是我见过的最好的，也不是最差的。给它一个C+或B-的评价。代码可以更漂亮一些。只是一个问题——为什么要为TON节点的简单JSON RPC编写C++包装器？为什么不使用更时髦的语言，比如Node、Python或Ruby？你总是可以把Fift编译器和虚拟机做成一个独立的模块。对于这样一个简单的任务，这样做看起来有些过度。


## **结论**

感谢你阅读我的乏味评审。我很高兴你在这里——这意味着你现在也是TON话题的专家了，可以在下次的“Drink & Code”聚会上用这篇文章的要点来给你的意中人留下深刻印象。我们可以得出以下结论：

1. 只有客户端的轻版本被“泄露”——只是一个围绕TON云节点RPC的包装器。
2. 目前还没有节点和验证代码，期待新的“泄露”。
3. 代码看起来太新且未准备好——几乎感觉像是一个快速包装，用来向投资者展示功能。
4. 除了查看你的地址、获取20个测试GRAM和Fift编译器（带有简化的虚拟机）外，我们还没有看到太多内容。
5. Fift的波兰表示法对普通开发者来说是地狱。为什么要过于复杂化？没人知道。
6. 我真心喜欢TON的文档。500多页的每一页都尽可能地提供了丰富的信息。现在很清楚TON及其所有组件将如何构建以及它们将如何工作。

总之，现在下结论还为时过早。但一旦TON云节点代码发布，你可以赌我会对其进行评审。不过，我还是很高兴终于了解了Telegram团队在做什么，而不是修复机器人API（说真的，Voicy最近几周一直遇到大问题，我很生气）。

这就是Nikita，Golden Borodutch Telegram频道的作者（抱歉，内容是俄语）。我还负责诚实的ICO评审——值得查看和订阅，以防止被骗入ICO。

对我来说最好的奖励就是你们能为这篇文章鼓掌50次（按住鼓掌按钮）并与几位对TON感兴趣的朋友分享这篇文章。非常感谢！祝你好运。

附言，我会在评论区回答关于TON的任何问题。干杯！


---
Nikita Kolmogorov, May 31, 2019

ref: https://borodutch.medium.com/ton-code-review-fd7ba036626b

